---
import { cn } from '~/lib/utils';
import { Lightbulb } from 'lucide-react';
---

<button
  data-theme-toggle
  transition:persist
  class={cn(
    'hover:bg-gray-soft inline-block rounded-md p-1 transition active:scale-95',
    Astro.props.class,
  )}
>
  <span class="sr-only">toggle theme</span>
    <Lightbulb />
</button>

<script>
  import { changeGiscusTheme } from '~/components/giscus';
  import { STORAGE_THEME_KEY, THEME_MAP } from '~/lib/theme';

  const themeList = Object.keys(THEME_MAP);

  function switchTheme() {
    const currentThemeIndex = themeList.findIndex((c) =>
      document.documentElement.classList.contains(c),
    );
    if (currentThemeIndex !== -1) {
      document.documentElement.classList.remove(themeList[currentThemeIndex]);
    }

    const nextTheme = themeList[(currentThemeIndex + 1) % themeList.length];
    localStorage.setItem(STORAGE_THEME_KEY, nextTheme);
    document.documentElement.classList.add(nextTheme);
    changeGiscusTheme(nextTheme);
  }

  function onToggleTheme() {
    if (!document.startViewTransition) switchTheme();
    document.startViewTransition(switchTheme);
  }

  function initClickListener() {
    document.querySelectorAll('[data-theme-toggle]').forEach((button) => {
      button.addEventListener('click', onToggleTheme);
    });
  }
  document.addEventListener('DOMContentLoaded', initClickListener);
  document.addEventListener('astro:page-load', initClickListener);
</script>
